<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>article</title>
    <link rel="stylesheet" type="text/css" href="css/reset.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" type="text/css" href="css/article.css">
    <link rel="stylesheet" type="text/css" href="font-awesome-4.7.0/css/font-awesome.min.css">
    <script type="text/JavaScript" src="js/jquery3-3-1.js"></script>
</head>
<body>
    <header>
        <nav>
            <div class="pull-left">
                <ul>
                    <li class="logo"><a href="#">MyBlog</a></li>
                </ul>
            </div>
            <div class="pull-right">
                <ul>
                    <li>
                        <div class="search-bar">
                            <input type="text" style="float: left" class="input-search" placeholder="搜博主/文章">
                            <a href="#" style="float: right" class="btn-search"><i id="search_button" class="fa fa-search" aria-hidden="true"></i></a>
                        </div>
                    </li>
                    <li class="login-center">
                        <a href="#" id="navAvatar">
                            <!--<img src="img/login.png">-->
                        </a>
                        <div class="user-control">
                            <!--<div>-->
                            <!--<a href="#" target="_blank">我的博客</a>-->
                            <!--</div>-->
                            <!--<div>-->
                            <!--<a href="#" target="_blank">关注/粉丝</a>-->
                            <!--</div>-->
                            <!--<div>-->
                            <!--<a href="#" target="_blank">修改资料</a>-->
                            <!--</div>-->
                            <!--<div>-->
                            <!--<a href="#" target="_blank">退出</a>-->
                            <!--</div>-->
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <div class="banner">
        <div class="title-box">
            <h6 class="title-blog">Elenore的博客</h6>
        </div>
    </div>

    <div class="container" style="margin-bottom: 200px">
        <aside>
            <div id="asideProfile" class="aside-box">
                <h3 class="aside-title">
                    个人资料
                </h3>
                <div class="profile-intro">
                    <div class="avatar-box">
                        <a href="#" id="userAvatar">
                            <!--头像-->
                            <!--<img src="img/login.png">-->
                        </a>
                    </div>
                    <div class="user-info">
                        <p class="name">
                            <!--id-->
                            <a href="#" target="_blank" class="text-truncate" id="uid">
                                Elenore
                            </a>
                        </p>
                    </div>
                </div>

                <div class="data-info">
                    <dl class="text-center" title="4">
                        <dt>文章</dt>
                        <dd>
                            <span class="count">4</span>
                        </dd>
                    </dl>
                    <dl class="text-center" title="0">
                        <dt>粉丝</dt>
                        <dd>
                            <span class="count">0</span>
                        </dd>
                    </dl>
                    <dl class="text-center" title="0">
                        <dt>关注</dt>
                        <dd>
                            <span class="count">0</span>
                        </dd>
                    </dl>
                    <dl class="text-center" title="0">
                        <dt>评论</dt>
                        <dd>
                            <span class="count">0</span>
                        </dd>
                    </dl>
                </div>

                <div class="grade-box">
                    访问：4396
                </div>

            </div>

            <div id="asideCategory" class="aside-box">
                <h3 class="aside-title">个人分类</h3>
                <div class="aside-content">
                    <ul id="cateUl">
                        <!--<li>-->
                        <!--<a href="#">nlp<span class="count">2篇</span></a>-->

                        <!--</li>-->
                        <!--<li>-->
                        <!--<a href="#">deep learning<span class="count">3篇</span></a>-->

                        <!--</li>-->
                    </ul>
                </div>
            </div>

            <div id="asideArchive" class="aside-box">
                <h3 class="aside-title" >归档</h3>
                <div class="aside-content">
                    <ul class="achieve-list" id="dateSortNum">
                        <!--<li><a href="#">2018年5月<span class="count">4篇</span></a></li>-->
                        <!--<li><a href="#">2018年4月<span class="count">1篇</span></a></li>-->
                    </ul>
                </div>
            </div>
            <div id="asideHotArticle" class="aside-box">
                <h3 class="aside-title">热门文章</h3>
                <div class="aside-content">
                    <ul class="hotArticle-list" id="hotArticleUl">
                        <!--<li>-->
                        <!--<a href="#">Title1</a>-->
                        <!--<p class="read">阅读量：233</p>-->
                        <!--</li>-->
                        <!--<li>-->
                        <!--<a href="#">Title2</a>-->
                        <!--<p class="read">阅读量：233</p>-->
                        <!--</li>-->
                        <!--<li>-->
                        <!--<a href="#">Title0</a>-->
                        <!--<p class="read">阅读量：233</p>-->
                        <!--</li>-->
                    </ul>
                </div>
            </div>

        </aside>

        <main>
            <div class="blog-content-box">
                <div class="article-title-box">
                    <h6 class="title-article"></h6>
                </div>

                <div class="article-info-box">
                    <div class="article-bar-top">
                        <span class="time"></span>
                        <div class="other-info">
                            <span class="read-count">阅读数：233</span>
                            <!--<a class="href-article-edit" href="#">编辑</a>-->
                        </div>
                    </div>
                </div>

                <article>
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Consequuntur cum magni obcaecati repellendus veniam! Commodi libero minus repudiandae suscipit vel! Ipsum labore molestiae quaerat quibusdam voluptatibus. Asperiores maiores molestias tempore?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Consequuntur cum magni obcaecati repellendus veniam! Commodi libero minus repudiandae suscipit vel! Ipsum labore molestiae quaerat quibusdam voluptatibus. Asperiores maiores molestias tempore?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                    <!--Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam doloribus et, eum ex facilis inventore ipsam nostrum nulla odio, provident quasi, quibusdam sequi voluptatum! Laudantium provident quis sit voluptate voluptates?-->
                </article>

                <div class="article-bar-bottom">

                </div>
            </div>

            <div class="comment-box">
                <div class="comment-edit-box">
                    <div class="user-img">
                        <!--<img src="img/login.png">-->
                    </div>
                    <form id="commentForm">
                        <textarea class="comment-content" name="comment-content" id="comment-content" placeholder="想对作者说点什么"></textarea>
                        <div class="btn-div">
                            <input type="button" class="btn-submit post_comment" value="发表评论" >
                        </div>
                    </form>
                </div>

                <div class="comment-list-container">
                    <div class="comment-list-box">
                        <!--<ul class='comment-list'>
                            <li class='comment-line-box'>
                                <a href='#' target='_blank'>
                                    <img class='avatar' src='img/login.png'>
                                </a>
                                <div class='right-box'>
                                    <div class='info-box'>
                                        <a target='_blank' href='#'>
                                            <span class='comment-name'>Elenore</span>
                                        </a>
                                        <span class='comment-date'>2018-5-21 19:55:18</span>
                                        <span class='floor-num'>#1</span>
                                    </div>
                                    <br>
                                    <div class='comment'>test comment</div>
                                </div>
                            </li>
                        </ul>-->
                    </div>

                </div>
            </div>

        </main>

    </div>

    <div class="backTop" onclick="">
        <i class="fa fa-arrow-up fa-3x" aria-hidden="true" ></i>
    </div>

    <script src="js/set_nav_banner.js"></script>
    <script src="js/set_aside.js"></script>

    <script>
        var article_id = getUrlParam("article_id"); // 得到要显示文章id
        var username = getUrlParam("username");
        jQuery(document).ready(function () {
            // title 和 banner
            // title
            $("title").html(username + "的博客  -myblog");
            // banner
            var blogTitle = document.getElementsByClassName('title-box')[0];
            blogTitle.innerHTML = "<h6 class=\"title-blog\">" + username + "的博客</h6>";

            $(document).on('click', '.banner', function () {
                window.location.href = "index.html?username=" + username;
            });

            $.ajax({
                type: "POST",
                url: "php/get_main.php",
                data: {
                    "do": "get_detail",  //指明要执行的操作
                    "article_id": article_id
                },
                dataType: 'json',
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert('连接错误：' + textStatus + errorThrown);
                },
                success: function (data) {//成功后显示文章详情
                    console.log(data);
                    // console.log('comment-avatar:' + data['avatar'][0]);
                    var blogTitle = document.getElementsByClassName('title-box')[0];
                    blogTitle.innerHTML = "<h6 class=\"title-blog\">" + username + "的博客</h6>";

                    // 时间
                    $(".time")[0].innerHTML = data.article[0]['create_time'];

                    //将文章详情显示
                    document.getElementsByClassName("title-article")[0].innerHTML = data.article[0]['title'];
                    document.getElementsByTagName("article")[0].innerHTML = data.article[0]['content'];
                    document.getElementsByClassName("read-count")[0].innerHTML = "阅读数：" + data.article[0]['read_num'];

                    // 评论区头像
                    $(".user-img").append("<img src='" + data['avatar'][0] + "' style='width: 50px;height: 50px;border-radius: 50%'>")

                    for(i in data.comments){
                        var m_div = document.createElement('div');   //create 一个div
                     m_div.innerHTML = "<ul class='comment-list'> <li class='comment-line-box'> <a href='index.html?username=" + data.comments[i]['username'] + "' target='_blank'>"+
                            "<img class='avatar' src='" + data.comments[i]['avatar'] + "'> </a> <div class='right-box'>"+
                            "<div class='info-box'> <a target='_blank' href='#'> <span class='comment-name'>"+data.comments[i]['username']+
                    "</span> </a> <span class='comment-date'>"+data.comments[i]['comment_time']+
                    "</span> <span class='floor-num'>#"+(parseInt(i)+1)+
                    "</span> </div> <br> <div class='comment'>"+data.comments[i]['comment_content']+
                    "</div></div> </li> </ul>"
                        var parent = document.getElementsByClassName('comment-list-box')[0];  //parent是名为article-list的第一个类，即我们div所要附加的父元素
                        parent.appendChild(m_div);  //给parent附加上div



                        
                    }
                    // 如果session和username一样就可以编辑文章
                    console.log(data['now_session']);
                    if (username === data['now_session']) {
                        $(".other-info").append("<a class='href-article-edit' href='edit_article.html?username=" + username + "&article_id=" + article_id + "'>编辑</a>");
                    }
                }
            });

            // 文章阅读量
            $.ajax({
               type: 'post',
               url: 'php/visited_num.php',
               data: {
                   do: 'article_visit',
                   username: username,
                   article_id: article_id
               },
               dataType: 'json',
               error: function (XMLHttpRequest, textStatus, errorThrown) {
                   alert('连接错误：' + textStatus + errorThrown);
               },
                success: function (data) {
                    if (data.code === 1) {
                        console.log('read_num and visited_num + 1') ;
                    }
                }
            });


            $("#commentForm").on('click','.post_comment',function () {
                var comment_content = document.getElementById("comment-content").value;
                //alert(comment_content);
                $.ajax({
                    type: "POST",
                    url: "php/post_comment.php",
                    data: {
                        "article_id": article_id,
                        "comment_content":comment_content
                    },
                    dataType: 'json',
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert('连接错误：' + textStatus + errorThrown);
                    },
                    success: function (data) {//成功后刷新页面
                        if(data.code === 1){
                            var link ="article.html" + '?article_id='+article_id;   //构造跳转url,附文章id，以后传给后台，获取文章详情
                            window.location.href=link;   //跳转到文章详情页面，附文章id
                        }
                        else if (data.code === 0) {
                            alert(data.msg);
                        }
                    }
                })
            })
        });
        console.log('article_id: ' + article_id);




        // function getQueryString(name) { //获取url上的参数----article_id，直接复制网上代码的
        //     var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"); //regular expression
        //     var r = window.location.search.substr(1).match(reg);
        //     if (r != null) return unescape(r[2]); return null;
        // }

        function getUrlParam(name){
            //正则表达式过滤
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            //正则规则
            // console.log("reg==="+reg);
            //search：返回URL的查询部分
            // console.log("location.search==="+location.search);
            //substr（1）：从字符串第一个位置中提取一些字符
            // console.log("location.search.substr(1)==="+location.search.substr(1));
            // match（）：在字符串内检索与正则表达式匹配的指定值，返回一个数组给r
            // console.log("window.location.search.substr(1).match(reg)==="+window.location.search.substr(1).match(reg));
            var r = window.location.search.substr(1).match(reg);
            //获取r数组中下标为2的值；（下标从0开始），用decodeURI（）进行解码
            // console.log("decodeURI(r[2])==="+decodeURI(r[2]));
            // console.log("-----------------分隔符------------------------");
            if (r != null) return decodeURI(r[2]); return null;

        }

        // 回到顶部
        $(function () {
            var back=$(".backTop");
            var win=$(window);
            var sc=$(document);
            win.scroll(function () {
                if(sc.scrollTop()>=190){
                    $(".backTop").fadeIn();
                }else{
                    $(".backTop").fadeOut();
                }
            })
            back.click(function () {
                $('body, html').animate({scrollTop:0}, 500);
            })
        });
    </script>
</body>
</html>